# 第3章 链路层

## 3.1 引言

- TCP/IP支持多种不同的链路层，依赖于使用的网络硬件类型
  - 有线局域网，如以太网
  - 城域网（MAN）
  - 有线语音网络，如支持调制解调器的电话线
  - 无线网络，如Wi-Fi（无线局域网）
  - ......
- 本章讨论的重点
  - 在以太网和Wi-Fi的链路层中，如何使用点到点协议（PPP）
  - 如何在在其它（链路或更高层）协议中携带链路层协议
  - 隧道技术
- 链路层的PDU被称为帧

## 3.2 以太网和IEEE 802局域网/城域网标准

- 首先描绘一个所有IEEE 802标准的蓝图

### 3.2.1 IEEE 802局域网/城域网标准

- 表3-1列出了支持TCP/IP的相关IEEE 802局域网和城域网标准
- 一些最流行的802标准

#### 3.2.1.1 802.3 标准

- 由第一个常见格式的以太网被采纳而来，目前被称为10Mb/s以太网或共享以太网
- 结构主要包括一个或多个站，被连接到一个共享的电缆段
- 带冲突检测的载波侦听多路访问（CSMA/CD）
  - 一个站首先检测介质（网络）是否空闲
  - 在空闲时发送数据
  - 若碰撞，则随机等待一段时间，再次尝试发送
  - 最终，每个站会得到机会发送，或者超时
- 当前，局域网中每个站的线路通常不共享，而是星形拓扑结构
  - 以太网交换机
  - 全双工（站点收发都实现）
  - 交换机可以通过交换机端口级联形成更大的以太网该端口被称为上行端口

#### 3.2.1.2 802.11 标准

- 被称为无线以太网或802.11
- 和802.3的联系
  - 帧格式和通用接口大部分来自802.3
  - 都是IEEE 802局域网标准的一部分
  - TCP/IP用于以太网的大部分功能，也可用于Wi-Fi网络

### 3.2.2 以太网帧格式

- 图3-3
  - 前导字段和SFD
    - ###
  - 目的地址（DST）和源地址（SRC）
    - 目的地址允许勋知道多个站点（广播或组播，第9章）
    - 广播用于ARP协议（第4章）
    - 组播用于ICMPv6协议（第8章）
  - 类型/长度字段
    - 用于确定头部后面的数据类型
    - 常见值
      - IPv4（0x0800）
      - IPv6（0x86DD)
      - ARP（0x0806）
    - 该字段可用于表示类型或长度
      - 若字段值大于等于1526，则表示类型
      - 若字段值小于等于1500，则表示长度
  - P/Q标签
    - 提供虚拟局域网和一些服务质量（QoS）知识符（3.2.3）
  - 有效载荷部分（数据区）
    - 放高层PDU的地方
    - 详细讨论在3.2.2.2

#### 3.2.2.1 帧校验序列/循环冗余校验

- 循环冗余校验（CRC）字段位于尾部，尾部在那里？？？
- n位CRC

- 扩展消息：补n位0
- 生成多项式：n+1位
- 二进制除法计算余数
- 余数的反码放在帧的CRC或帧校验序列（FCS）字段
- 接收方收到数据后，用同样的方法计算余数，并且和FCS字段比较

#### 3.2.2.2 帧大小

- 最小帧
  - 长度为64字节，要求有效载荷长度为48字节
  - 当有效载荷不够最小长度时，填充字节0到有效载荷尾部
  - 最小帧长度为64字节的原因
    - 以太网的争用期为51.2微秒，也就是一帧至少要在介质内停留这么久
      - 可能发生碰撞
      - 碰撞的时候要求这个帧还在介质内，才能知道是哪个帧发生了碰撞
      - 某个帧可能走了一段路程才发生碰撞，而且碰撞信号也要原路返回，因此一帧从发送出去一段时间后才能得知发生了碰撞
      - 因此需要一定时长的争用期
    - 在10Mb/s以太网中，需要多大的帧，才能在介质内停留至少51.2微秒？
      - 10Mb/s * 51.2微秒 = 64B
- 最大帧
  - 长度是1518字节（包括4字节CRC和14字节头部）
  - 选择这个值的原因
    - 如果一个帧出错，只需要重发这么大的帧（不会太大）
    - MTU大小限制为1500字节
  - 为了发送更大的消息，需要多个帧
    - 多个帧构成更大的上层PDU，存在的问题
      - 每个帧都贡献了固定开销（14字节的头部和4字节的CRC）
      - 为了容易恢复数据，并且区分自己和其它站的流量，以太帧不能无缝压缩在一起
      - 包间距（IPG）时间
      - 太多帧组合在一起，会有很多包间距，降低帧的效率
      - 解决办法是，以太网巨型帧

### 3.2.3 802.1p/q：虚拟局域网和QoS标签

- 位于同一以太网中的每台主机互连已经成为可能
  - 任何主机都可直接与其它主机通信
  - 广播到每台主机将带来大量网络流量，且可能引发安全问题
- 虚拟局域网（VLAN）
  - 解决每台主机都可以互相通信引发的问题
  - 将所有主机分割为若干VLAN
  - 连载同一交换机但在不同VLAN中的两台主机，它们之间的流量需要一台路由器来传递（不同网段之间需要路由器）
  - 现在已有交换机/路由器组合设备
  - 现代高性能路由器逐渐取代VLAN，为什么可以取代？？？
  - 工作站（主机）映射到VLAN的方法（如何划分若干个VLAN）
    - 通过端口分配VLAN，交换机的某（几）个端口所连接的站被分配在一个特定VLAN中
    - 基于MAC地址的VLAN（哈希）
    - 基于IP地址的VLAN
  - 交换机确保流量不在VLAN之间泄漏
    - 要识别出某个帧属于哪个VLAN
    - VLAN标签，见图3-3
      - VLAN标识符，12位
      - ###

### 3.2.4 802.1AX：链路聚合（以前的802.3ad）

###

## 3.3 全双工、省电、自动协商和802.1X流量控制

- 以前的以太网仅工作在半双工模式，并使用一条共享的电缆
  - 同一时间只能在一个方向发送数据
  - 任何时间点只有一个站可以发送帧
- 现在网络是很多链路的组合
  - 多个站可以同时进行数据交换
  - 全双工，可以禁用冲突检测电路
  - 可以增加以太网的物理长度，因为冲突检测需要时间
- linux中ethtool程序查看和设置以太网接口的属性
  - ###
- 自动协商
  - 接口交换信息（如速度）和功能（如半双工还是全双工）的机制

### 3.3,1 双工不匹配

- 自动协商的互操作性问题
  - 两边端口使用不同的双关配置
  - 自动协商在某端被禁用
- 这种情况就会导致双工不匹配
  - 连接不会完全失败，但是性能会显著下降
  - 半双工接口可能会检测到冲突，从而触发以太网MAC的CSMA/CD的指数退避功能，导致重传
  - 轻负载的网络一般不会出现性能下降问题

### 3.3.2 局域网唤醒（WoL）、省电和魔术分组

###

### 3.3.3 链路层流量控制

- 交换机在某些情况下需要将帧缓存一段时间
  - 多个站发送到同一目的地的时候，可能发生碰撞，需要缓存重发
  - 总之，如果一个站聚合的流量速率超过该站的链路速率，那么帧就开始存储在中间交换机中
  - 如果缓存时间过久，帧可能被丢弃
- 为了缓解这种缓存时间过久的情况，一种方法是在发送方采取流量控制（使它慢下来）
  - 通过在交换机和网卡之间发送特殊信号帧来实现流量控制
  - 以太网使用PAUST消息实现这一点
    - PAUSE消息包含在MAC控制帧中
    - MAC控制帧符合图3-3的帧结构
    - 长度/类型字段为0x8808
    - MAC控制操作码0x0001，是紧跟在长度/类型字段后的一个2字节的操作码
    - 如果收到这种帧，表示建议它减缓发送速度
  - 流量控制可能有重大负面影响，因此不推荐使用

## 3.4 网桥和交换机

- 交换机本质上是高性能的网桥
- 交换机构成局域网见图3-8
  - 通过“学习”，每个交换机会知道每个可由哪个端口到达
  - 每个交换机的这些结果会被存储在过滤数据库中
- 目前多数操作系统支持网络接口之间的网桥功能，因此多个接口的计算机可以用做网桥
- 需要解决两个以上的网桥通过冗余链路互联的问题
  - 冗余链路见图3-12
  - 如果采用简单的洪泛转发帧，会造成流量成倍增长
  - 一种解决办法：生成树协议（STP）

### 3.4.1 生成树协议

###

### 3.4.2 802.1ak：多注册协议

###

## 3.5 无线局域网——IEEE 802.11（Wi-Fi）

- 图3-17的一些术语
  - 站（STA）
  - 接入点（AP）
  - 基本服务集（BSS）：一个接入点和相关的站
  - 分布式服务（DS）
  - 扩展服务集（ESS）：接入点之间使用一种有线的分布式服务连接而形成
  - 图3-17这种方式被称为基础设施模式
- Ad hoc（自组织）模式
  - ###

### 3.5.1 802.11帧

- 图3-18
  - 前导码
    - 用于同步？？？
    - 取决于正在使用的802.11协议类型，有哪些类型？？？
  - 物理层会聚程序（PLCP）头部
    - 以独立于物理层的方式提供特定的物理层信息？？？
    - 帧的PLCP部分的传输速率通常比其余部分低，不应该是一个速度的吗？？？
      - 提高正确交付的概率（较低速度容错）
      - 提供对传统设备的兼容性和防止慢速操作的干扰
  - MAC PDU（MPDU）
    - 与以太网相似，但有一些额外的字段
    - MPDU以帧控制字开始，其中包括长2位的类型字段，用于识别该帧的类型
      - 管理帧
      - 控制帧
      - 数据帧
    - 接下来会详细讨论这几种类型的帧

#### 3.5.1.1 管理帧

###

#### 3.5.1.2 控制帧

###

#### 3.5.1.3 数据帧、分片和聚合

- 802.11支持帧分片和帧聚合

##### 3.5.1.3.1 帧分片

- 每个分片有自己的MAC头部和尾部的CRC，并且独立于其它分片处理
- 除非使用块确认功能，否则每个分片会被单独发送，并由接收方为每个分片产生一个ACK
- 信道有明显干扰时，分片有助于提高性能，因为重传只需要重传分片
- 分片仅用于目的地址为单播的帧
- 顺序控制字段包含分片号（4位）和序列号（12位）
- 帧控制字中的更多标志字段表示更多分片没有到达，最后一个分片将这个位设置位0
- 当所有同一序列号的分片被接受，并且最后一个分片的更多标志字段为0，这个帧被重组并交给更高层协议来处理

##### 3.5.3.1.2 帧聚合

- 两种类型的聚合见图3-19
- 聚合的MAC服务数据单元（A-MSDU）
  - 将多个完整的802.3（以太网）帧聚合在一个802.11帧中
  - 每个帧有自己的802.3帧头部，共用帧校验序列（FCS）
- 聚合的MAC协议数据单元（A-MPDU）
  - 多个（最多64个）802.11帧可聚合起来
  - 每个帧有自己的802.11 MAC头部和FCS，每个帧最多4095字节
  - 因为每个子帧都携带自己的FCS，所以可有选择地重传出错的帧
  - 802.11n中的块确认功能也是可以确认每个子帧（选择确认），目的类似，但是实现细节不同，第14章详细介绍选择确认
  - 这样聚合的目的是什么？？？只是为了共用前导字段和PLCP头部吗？？？
  - 为什么除了每个MPDU有MAC头部以外，整个还有MAC头部？？？

### 3.5.2 省电模式和时间同步功能

###‘

### 3.5.3 802.11介质访问控制

- 与有线网络（如802.3局域网）相比，在无限网络中检测“冲突”具有更大挑战性
- 802.11标准采用三种方法控制共享的无线介质
  - 点协调功能（PCF）
    - 使用并不广泛，不详细讨论
  - 混合协调功能（HCF）
  - 分布式协调功能（DCF）
    - 重点介绍
    - 一种CSMA/CA类型，是基于竞争的介质访问方法
      - 和有线局域网中使用的CSMA/CD相似（3.2.1.1）
      - 802.11信道仲裁是对CSMA/CA的改进，提供优先访问某些站或帧的功能
    - 802.11载波侦听能以物理和虚拟方式实现

#### 3.5.3.1 虚拟载波侦听、RTS/CTS和网络分配向量

- 帧的持续时间字段
  - 发送方基于帧拆毁嗯读、传输速率和PHY特性（如速率等）设置持续时间字段，PHY？？？
  - 在范围内的任何站都可以看到持续时间字段
- 网络分配向量（NAV）
  - 每个站保持一个这样的计数器
  - 基于本地时钟递减
  - 当一个站帧听到某个帧的持续时间大于自己的NAV时，把自己的NAV设为这个值
  - 当本地NAV不为0时，（这个站）认为介质繁忙
  - 在接收到一个ACK后，本地NAV复位为0
  - 也就是说，发送方需要预测自己发送的帧能在介质中停留多久？？？接收方的“侦听”是否要这个帧到达自己这里，才能帧听到？？？

#### 3.5.3.2 物理载波侦听（CCA）

- ###

#### 3.5.3.3 DCF冲突避免/退避过程

- 确定信道空闲的时候，一个站在传输之前需要推迟访问该信道
  - 信道空闲的判断：本站已到达NAV持续时间，且CCA没有提示信道繁忙，CCA是什么？？？
  - 退避时间，等待这么久之后再访问该信道，为什么要等待？？？
    - 退避时间等于一个随机数和时隙的乘积
    - 时隙依赖于PHY，通常是几十微秒
    - 随机数
      - ###
- 在无线环境中，冲突检测是不实际的
  - 难以发现发送方和接收方同时发送，也难以监听自己之外的传输，那有线是怎么实现的，碰撞的时候会发送碰撞信号，为什么无线的不可以？？？
  - 冲突避免代替冲突检测
- ACK是针对单播帧的响应，以确定一个帧是否正确传递
  - 当一个站正确接受一个帧时，在等待一小段时间（称为端时间间隔（SIFS））后开始传输ACK，并且不考虑介质的忙碌/空心状态，为什么要等待一小段时间？？？
    - 这样不会出问题，由于SIFS的值始终比DIFS小，因此ACK可以优先访问信道，这两个分别是什么？？？
  - 源站在一定时间内没有接收到ACK，意味着传输失败，启动退避过程，重新尝试发送帧



#### 3.5.3.4 HCF和802.11e/n的QoS

###

### 3.5.4 物理层的细节：速率、信道和频率

###

### 3.5.5 Wi-Fi安全

###

### 3.5.6 Wi-Fi网状网

###

## 3.6 点到点协议（PPP）

- 用于在串行链路上传输IP数据报的流行方法

- 一个协议集合而非单一的协议，支持建立链接的基本方法——链路控制协议（LCP），以及一系列NCP协议

### 3.6.1 链路控制协议

- 链路控制协议用于在点到点链路上建立和维护低层的双方通信路径，因此PPP操作只需关注一条链路的两端，不需要像以太网和Wi-Fi的MAC层协议那样处理共享资源访问的问题
  - 说明PPP和以太网，Wi-Fi是等价的？？？它们之间有什么联系？？？
  - 上面的说法有什么因果关系吗？？？
- PPP基本帧格式借用了高级数据链路控制（HDLC）的格式，见图3-22
  - 标志字段，值为0x7E，包围整个帧
    - 通过这些字段来发现一个帧的开始和结束
    - 802.3帧和802.11帧长度都是固定的，所以不需要这样的分界标志
    - 如果标志字段的值出现在帧内部，需要处理，处理办法取决于PPP工作在同步还是异步链路上，这里的同步和异步？？？
      - 异步链路上，使用字节填充，用别的字节序列替换
      - 同步链路上，使用位填充，遇到连续6个1的序列，在5个连续1之后填充一个0
  - 地址字段
    - 指定哪个站正在处理
    - 由于PPP只关心一个目的地，这个字段总是被设置为0xFF（所有站），什么意思？？？
  - 控制字段
    - 用于知识帧序列和重传行为
    - 这些可靠性功能通常不是由PPP实现，因此控制字段为固定值0x03
    - 地址字段和控制字段在PPP中都是固定的常数，因此传输过程中可以通过一个称为地址和控制字段压缩（ACFC）的选项来省略它们
    - 链路层网络应该提供多少可靠性一直存在争议
      - 以太网中，放弃之前可尝试重传多达16次
      - 通常PPP被设置为不重传，尽管有时候也会有重传
  - 协议字段
    - 表明携带的数据类型，有哪些？？？
  - FCS
    - 验证用

#### 3.6.1.1 LCP操作

##### 3.6.1.1.1 LCP封装PPP分组，额外的字段

- LCP在基本PPP分组之上进行了简单的封装，见图3-23
  - PPP协议字段值始终是0xC021
  - 标识字段为序列号
  - 代码字段给出了请求或响应的操作类型
  - 长度字段给出了LCP分组的字节长度
    - 不能超过链路的最大接收单元（MRU），什么来的？？？
    - 是LCP协议的一部分，PPP协议通常不提供这种字段

##### 3.6.1.1.2 LCP的主要工作是使一条点到点链路达到最低要求

- LCP的主要工作是使一条点到点链路达到最低要求（能正常工作），因此需要以下消息类型
  - 配置消息
    - 使链路两端开始基本配置过程，并建立商定的选项
    - 终止消息
      - 完成后清除一条链路
    - ###

##### 3.6.1.1.3 环回模式（回路）

###

##### 3.6.1.1.4 PPP链路的生命周期

- PPP链路的生命周期
  - 图3-24

#### 3.6.1.2 LCP选项

###

### 3.6.2 多链路PPP

###

### 3.6.3 压缩控制协议

###

### 3.6.4 PPP认证

###

### 3.6.5 网络控制协议

###

### 3.6.6 头部压缩

###

### 3.6.7 例子

###

## 3.7 环回

###

### 3.8 MTU和路径MTU

- 最大传输单元（MTU）

  - 在很多链路层网络中，携带高层协议PDU的帧大小是有限制的
    - 以太网有效载荷的字节数通常被限制为1500
    - PPP通常采用同样的大小以保持与以太网兼容

  - 分组网络和流类型网络，两者有什么区别？？？
    - 大多数的分组网络（如以太网）都有固定的上限
    - 大多数的流类型网络（串行链路）提供可设置的上限，可被帧协议（如PPP）使用
  - 如果IP发送一个比链路层MTU大的数据包，则进行分片（第5章，第10章）

- 路径MTU

  - 当两台主机跨越多个网络通信时，每条链路可能有大小不同的MTU，其中最小的MTU称为路径MTU
  - 路径MTU发现（PMTUD）机制
    - ###

## 3.9 隧道基础

###

### 3.10 与链路层相关的攻击

###

