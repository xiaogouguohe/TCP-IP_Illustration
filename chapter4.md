# 第4章 地址解析协议

## 4.1 引言

- 为什么需要IP地址和硬件地址的转换？？?
- 地址解析协议（ARP)
  - 在IPv4地址和硬件地址之间的映射
  - 仅用于IPv4，IPv6使用邻居发现协议，被合并如ICMPv6（第8章）
  - 动态映射，会自动执行和随时间变化，而不需要系统管理员重新配置
- 硬件地址和IP地址的生成（分配）
  - 硬件地址
    - 由设备制造商定义
    - 存储在设备的永久性内存
    - 不会改变
  - IP地址
    - 由用户或网路管理员分配
    - 可以改变，如设备移动时常从维护附近网络连接点的地址池中获得，在系统启用或配置时分配（第6章）

## 4.2 一个例子（直接交付）

- 使用Web浏览器打开网址http://10.0.0.1
  - URL包含IPv4地址，而不是更常见的域名或主机名，是为了强调一个事实，例子中是共享相同IPv4前缀的相关系统（第2章），也就是一个子网内的IPv4地址
  - 假设是同一子网，因此访问的是本地的Web服务器，以说明直接交付的运行原理

- 直接交付发生在，一个IP数据报被发送到一个IP地址，而该地址与发送方有相同IP前缀的情况下（同一子网）

- IPv4直接交付的基本操作
  - 应用程序是一个Web浏览器，调用一个函数来解析URL，看是否包含主机名，这里不是，所以应用程序使用IPv4地址10.0.0.1
  - 向10.0.0.1发送IPv4数据报，通过TCP协议，请求建立连接（第15章介绍细节）
  - 假设10.0.0.1和发送方在同一个子网，数据报不用经过路由器
  - 假设以太网兼容地址被用于IPv4子网，则发送方必须将IPv4目的地址转换为48位的以太网地址（逻辑Internet地址向对应物理硬件地址转换）
    - ARP实现这个功能
    - ARP仅适用于广播，也就是要能把一个消息交付到它连接的素有网络设备
  - ARP向所有主机发送一个称为ARP请求的以太网帧，这被会层为链路层广播
  - 广播域中的所有系统都可接收ARP请求，但是只有使用请求包含的IP地址的系统才会响应一个ARP应答，接收ARP请求的主机学习到这个IPv4到MAC地址的映射，并且记录在内存中（见4.3）
  - ARP应答被发送方接收，现在可发送数据报，定向发送

## 4.3 ARP缓存

- arp命令查看当前的缓存

## 4.4 ARP帧格式

- ARP帧属于以太网（802.3）帧，见图4-2
  - 目的地址全为1，是广播地址
  - 长度或类型字段必须为0x0806
  - 硬件类型字段
    - 指出硬件地址类型
    - 常见的地址类型有MAC地址，物理地址和链路层地址（也就是以太网地址，当网络基于IEEE 802.3/以太网规范时）
    - 在这里，这个字段的值为1，表示以太网
  - 协议类型字段
    - 映射的协议地址类型
    - 在这里，这个字段的值为0x0800，标识IPv4
  - 硬件大小和协议大小
    - -分别指出硬件地址和协议地址的字节数
    - 在这里，值分别为6和4
  - Op字段
    - 指出该操作是什么，有一下几种
      - ARP请求（1）
      - ARP应答（2）
      - RARP请求（3）
      - RARP应答（4）
    - 该字段必须，因为ARP请求和ARP应答的长度/类型字段相同，无法区分
  - 发送方硬件地址、发送方协议地址、目的硬件地址、目的协议地址

## 4.5 ARP例子

- 用Telnet建立TCP/IP连接
- 用tcpdump命令查看运行ARP时发生的过程

### 4.5.1 正常的例子

###

### 4.5.2 对一个不存在主机的ARP请求

###

## 4.6 ARP缓存超时

- 每个条目可能都有自己的超时时间
  - 完整条目（4.5.1）的超时时间为20min
  - 不完整条目（4.5.2）的超时时间为3min
- 启动超时的时机
  - 在每次使用一个条目后会为它重新启动20分钟的超时，这是目前常见的实现
  - 也有些规范规定了每个条目即使在使用也应启动超时

## 4.7 代理ARP

- 使用一个系统（通常是一台专门配置的路由器），可回答不同主机的ARP请求
- 这使ARP请求的发送者认为这个系统就是目的主机，尽管目的主机可能不存在
- ARP代理历史上曾被用于这样的场景
  - 两个物理网络互相隐蔽自己
  - 这种情况下，两个物理网络可使用相同的IP前缀，把中间的路由器配置为一个代理ARP，由它来响应某个网络对另一个网络的ARP请求
  - 这样做是因为，和这些原因有什么关系？？？
    - 有些系统无法进行子网划分
    - 有些系统使用比较旧的广播地址（全0的主机ID，而非全1）

## 4.8 免费ARP和地址冲突检测

###

## 4.9 arp命令

###

### 4.10 使用ARP设置一台嵌入式设备的IPv4地址

###

### 4.11 与ARP相关的攻击

- 使用代理ARP（4.7），假扮主机
- ###

